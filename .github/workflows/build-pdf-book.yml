name: Build PDF Book

on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  generate-pdf:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      LEVELS: "A1 A2"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pandoc and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended fonts-dejavu-core

      - name: Set version info
        run: |
          VERSION=$(python -c "import pathlib,re; default='0.0.0'; path=pathlib.Path('manifest.yml'); text=path.read_text(encoding='utf-8') if path.exists() else ''; match=re.search(r'^version:\s*(.+)$', text, re.MULTILINE); value=(match.group(1).strip() if match else default); value=value.strip('\"').strip(\"'\"); print(value)")
          if [ -z "$VERSION" ]; then VERSION="0.0.0"; fi
          echo "BOOK_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BOOK_TAG=$VERSION" >> $GITHUB_ENV
          echo "BOOK_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Ensure version tag is unique
        run: |
          git fetch --tags
          if git rev-parse "$BOOK_TAG" >/dev/null 2>&1; then
            echo "Tag $BOOK_TAG already exists. Update manifest.yml version before rerunning."
            exit 1
          fi

      - name: Build PDFs for each level
        run: |
          printf '%s\n' \
            "import sys" \
            "import re" \
            "from pathlib import Path" \
            "" \
            "media_pattern = re.compile(r\"(audio|\\.mp3|\\.mp4|\\.wav|\\.ogg|\\.m4a)\", re.IGNORECASE)" \
            "link_pattern = re.compile(r\"\\[([^\\]]+)\\]\\(([^)]+)\\)\")" \
            "" \
            "def clean_links(text: str) -> str:" \
            "    return link_pattern.sub(r\"\\1\", text)" \
            "" \
            "def process(path_str: str) -> None:" \
            "    path = Path(path_str)" \
            "    text = path.read_text(encoding='utf-8')" \
            "    if text.startswith('---'):" \
            "        text = re.sub(r\"^---\\r?\\n.*?\\r?\\n---\\r?\\n?\", '', text, count=1, flags=re.S)" \
            "    text = clean_links(text)" \
            "    for line in text.splitlines():" \
            "        if media_pattern.search(line):" \
            "            continue" \
            "        print(line)" \
            "" \
            "if __name__ == '__main__':" \
            "    process(sys.argv[1])" \
            > strip_md.py

          for LEVEL in $LEVELS; do
            if [ ! -d "$LEVEL" ]; then
              echo "Skipping $LEVEL (directory not found)"
              continue
            fi

            echo "Building PDF for $LEVEL"
            rm -f md-order.txt md-list-cover.txt md-list-filtered.txt combined-"$LEVEL".md cover-"$LEVEL".md
            ORDER_FILE="$LEVEL/pdf-order.txt"

            if [ -f "$ORDER_FILE" ]; then
              echo "Using $ORDER_FILE for ordering"
              sed -e 's/\r$//' "$ORDER_FILE" | sed '/^[[:space:]]*$/d' | sed '/^[[:space:]]*#/d' > md-order.txt
            else
              echo "Order file not found for $LEVEL; discovering markdown files"
              find "$LEVEL" -path "$LEVEL/tmp" -prune -o -path "$LEVEL/.obsidian" -prune -o -name '*.md' -print | sort > md-order.txt
            fi

            grep -v '^.*/.github/' md-order.txt > md-list-filtered.txt || cp md-order.txt md-list-filtered.txt

            COVER_FILE="cover-$LEVEL.md"
            cat <<EOF > "$COVER_FILE"
\\begin{titlepage}
\\centering
\\vspace*{4cm}
{\\Huge Holandes para hispanohablantes}\\[1.5cm]
{\\Large Nivel $LEVEL}\\[0.5cm]
{\\large Version $BOOK_VERSION}\\[0.5cm]
{\\large Compilado el $BOOK_DATE}\\[3cm]
{\\large Curso autodidacta en formato Markdown/PDF}\\
\\end{titlepage}
\\clearpage
EOF

            printf '%s\n' "$COVER_FILE" > md-list-cover.txt
            cat md-list-filtered.txt >> md-list-cover.txt

            COMBINED="combined-$LEVEL.md"
            while IFS= read -r f; do
              if [ -f "$f" ]; then
                printf '\n\n<!-- Source: %s -->\n\n' "$f" >> "$COMBINED"
                python strip_md.py "$f" >> "$COMBINED"
              else
                echo "Warning: listed file '$f' not found" >&2
              fi
            done < md-list-cover.txt

            OUTPUT="holandes-curso-${LEVEL}-${BOOK_VERSION}.pdf"
            pandoc "$COMBINED" -o "$OUTPUT" \
              --pdf-engine=xelatex \
              -V mainfont="DejaVu Sans" \
              -V geometry:a4paper \
              -V geometry:margin=2.5cm \
              --toc --number-sections
          done

          rm -f strip_md.py md-order.txt md-list-filtered.txt md-list-cover.txt combined-*.md cover-*.md

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: holandes-curso-pdfs
          path: holandes-curso-*.pdf

      - name: Create GitHub Release with PDFs
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.BOOK_TAG }}
          name: "Holandes Curso - v${{ env.BOOK_VERSION }}"
          body: "Automated PDF export of the Holandes vault."
          files: "holandes-curso-*.pdf"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
